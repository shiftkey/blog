<!DOCTYPE html>

<!-- 
320 and Up boilerplate extension
Author: Andy Clarke
Version: 0.9b
URL: http://stuffandnonsense.co.uk/projects/320andup 
-->

<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!-- TODO: appcache definition -->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>
<meta charset="utf-8">

<title>Using Rx to Implement Filtering in MahTweets</title>
<meta name="description" content="">
<meta name="author" content="brendan forster">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">

<!-- robots -->
<meta name="robots" content="/robots.txt" />

<!-- For less capable mobile browsers
<link rel="stylesheet" media="handheld" href="css/handheld.css?v=1">  -->

<!-- For all browsers -->
<link rel="stylesheet" media="screen" href="/css/style.css?v=1">

<link rel="stylesheet" media="print" href="/css/print.css?v=1">
<!-- For progressively larger displays -->
<link rel="stylesheet" media="only screen and (min-width: 480px)" href="/css/480.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 768px)" href="/css/768.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 992px)" href="/css/992.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 1382px)" href="/css/1382.css?v=1">
<!-- For Retina displays -->
<link rel="stylesheet" media="only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min-device-pixel-ratio: 2)" href="/css/2x.css?v=1">

<link rel="stylesheet" media="screen" href="/css/custom.css?v=1">

<!-- JavaScript at bottom except for Modernizr -->
<script src="/js/libs/modernizr-1.7.min.js"></script>

<!-- For iPhone 4 -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/h/apple-touch-icon.png">
<!-- For iPad 1-->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/m/apple-touch-icon.png">
<!-- For iPhone 3G, iPod Touch and Android -->
<link rel="apple-touch-icon-precomposed" href="/img/l/apple-touch-icon-precomposed.png">
<!-- For Nokia -->
<link rel="shortcut icon" href="/img/l/apple-touch-icon.png">
<!-- For everything else -->
<link rel="shortcut icon" href="/favicon.ico">

<!--iOS. Delete if not required -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-startup-image" href="/img/splash.png">

<!--Microsoft. Delete if not required -->
<meta http-equiv="cleartype" content="on">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<!-- http://t.co/y1jPVnT -->
<link rel="canonical" href="using-rx-to-implement-filtering-in-mahtweets.html">
</head>


<body class="clearfix">

<header role="banner" class="clearfix">
	<h1>Using Rx to Implement Filtering in MahTweets</h1>
</header>

<div class="content clearfix">

	<div id="post">
<p>As we're kicking development off for the next version of MahTweets in the coming weeks, the team has been looking at experimenting with new technology and bringing the most useful stuff into the application.</p>

<p>Filtering is one of the things that MahTweets is famous for, but we're always looking for ways to make it better and easier. We've been experimenting with using the <a href="http://msdn.microsoft.com/en-us/devlabs/ee794896">Reactive Extensions (Rx) for .NET</a> to simplify the entire pipeline and provide more freedom in the application.</p>

<h2>The Current Status</h2>

<p>MahTweets allow the user to filter streams by update type, contact or text. Filters can be applied to individual streams or globally.</p>

<p>Roughly speaking, this is how the filters are applied.</p>

<center><a href="img/posts/FiltersClassic.png"><img src="img/posts/FiltersClassic.png" width="700" /></a></center>


<p>Updates from external services are added to the queue, which then raises CollectionChangedEvent notifications to each views. The view is responsible for running an update through its configured filters.</p>

<p>Limitations about this approach:</p>

<ul>
<li>Global Ignores were implemented separately.</li>
<li>Custom filtering was implemented per update type.</li>
<li>UI was coupled to stream container and specific parameters.</li>
</ul>


<h2>First Cut using Rx</h2>

<p>FYI: If you're not familiar with the Observer Pattern, check out the <a href="http://en.wikipedia.org/wiki/Observer_pattern">Wikipedia article</a> for starters. Rx uses the Observer pattern heavily.</p>

<p>We had a habit of using the phrase "filter" in many places of the application. To clarify our intent, we introduced two specific interfaces:</p>

<ul>
<li><strong>IStatusSubscriber</strong> - an extension which subscribes to a stream of incoming requests.</li>
<li><strong>IConditionalSubscriber</strong> : <strong>IStatusSubscriber</strong> - an extension which filters the updates before propogating to its consumers. Pass-thru or exclude filters can be specified.</li>
</ul>


<p>Replacing the Queue of messages with an IObservable/IObserver dual allows the application to leverage the Subject&lt;T&gt; class to manage the interactions between the services and the clients. This class resides in System.Reactive.dll and implements both IObservable&lt;T&gt; and IObserver&lt;T&gt;.</p>

<p>MahTweets also had some demo plugins for stream analytics, and abstracting away the queue support allows the application to plug in additional "global" services, using the same interfaces. Rx also allows observers to specify which thread to execute on, so the usage of the Dispatcher, TaskPool or ThreadPool (depending on scenario) can be configured without any plumbing code.</p>

<p>The interactions between these components now looks like:</p>

<center><a href="img/posts/RxFirstCut.png"><img src="img/posts/RxFirstCut.png" width="700" /></a></center>


<p>The biggest change is that subscribers interact with the IObservable, rather than being encompassed within the view. Each list still combines a set of filters, which display the combined set of results on-screen. However, when multiple filters are run in parallel, invalid items may appear.</p>

<p>Limitations about this approach:</p>

<ul>
<li>Excluded updates may be propogated through other subscribers in the same view.</li>
<li>Global Ignores still not supported.</li>
</ul>


<h2>Back to the Drawing Board</h2>

<p>So after some shut-eye and sun, I revisited the initial design for the IObservable implementation. What stood out to me was that:</p>

<ul>
<li>Include and exclude side-by-side has always been somewhat complex - both for users to understand, and determining which takes priority.</li>
<li>Include and exclude filters didn't need to exist in the same location.</li>
<li>Rx can support chaining observers, however...</li>
<li>Chaining isn't what the Observer pattern is about.</li>
</ul>


<p>After some more musing, I formed an opinion about subscriber rules (only mine so far):</p>

<p><strong>An exclude rule is applied globally. An include rule is applied locally.</strong></p>

<p>From my experiences with using Twitter, the typical use cases for exclude filters are:</p>

<ul>
<li>"Great, another Twitter spam concept..." <em>looks at paper.li</em></li>
<li>"Person XYZ is tweeting too much right now. I don't want to hear him for a while..."</li>
<li>"Oops, I said the i-word and the spammers are out and about..."</li>
</ul>


<p>On the other hand, the use cases for include filters can be like:</p>

<ul>
<li>"I want to see what <em>this</em> group of contacts is talking about..."</li>
<li>"I want to see tweets mentioning 'ABC' - (side note: more on search later)..."</li>
<li>"I want to see my mentions/messages..."</li>
</ul>


<p>Compare and contract (perhaps your experiences differ).</p>

<h2>Second Cut using Rx</h2>

<p>The second cut of the design allows for three subscriber hooks:</p>

<ul>
<li>Subscribers register against the source observable, without any filtering applied.</li>
<li>Subscribers register against the output observable, with the global filtering applied.</li>
<li>Exclude rules are applied closer to the source.</li>
</ul>


<center><a href="img/posts/RxSecondCut.png"><img src="img/posts/RxSecondCut.png" width="700" /></a></center>


<p>An internal subscriber verifies a status against a list of exclusions, and propogates the status further if it is valid. Each view only requires its inclusion rules (or a wildcard rule if no rules specified) to display results.</p>

<h2>The Next Step</h2>

<ul>
<li>Debate with <a href="http://twitter.com/aeoth">@aeoth</a> on this</li>
<li>Performance Testing against a large set of data.</li>
<li>Demonstrating how external plugins can include their own rules.</li>
<li>Demonstrate user interface changes for vNext.</li>
</ul>


</div>


	<div id="disqus_thread"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://shiftkey.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>03 Dec 2011</span> &raquo; <a href="alt-net-open-spaces-2011.html">ALT.NET Open Spaces</a></li>
    
      <li><span>26 Oct 2011</span> &raquo; <a href="jquery-knockout-win8.html">jQuery and KnockoutJS in Win8? Sure, why not!</a></li>
    
      <li><span>23 Oct 2011</span> &raquo; <a href="ddd-brisbane.html">I'm speaking at DDD Brisbane</a></li>
    
  </ul>
</div>

</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>

<!--[if (lt IE 9) & (!IEMobile)]>
<script src="/js/libs/DOMAssistantCompressed-2.8.js"></script>
<script src="/js/libs/selectivizr-1.0.1.js"></script>
<script src="/js/libs/respond.min.js"></script>
<![endif]-->

<script>
var _gaq=[['_setAccount','UA-8441214-1'],['_trackPageview']]; 
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<noscript>Your browser does not support JavaScript!</noscript>

</body>
</html>