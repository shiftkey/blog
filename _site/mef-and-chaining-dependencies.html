<!DOCTYPE html>

<!-- 
320 and Up boilerplate extension
Author: Andy Clarke
Version: 0.9b
URL: http://stuffandnonsense.co.uk/projects/320andup 
-->

<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!-- TODO: appcache definition -->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>
<meta charset="utf-8">

<title>MEF and Chaining Dependencies</title>
<meta name="description" content="">
<meta name="author" content="brendan forster">

<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS feed"> 
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="ATOM feed"> 


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">

<!-- robots -->
<meta name="robots" content="/robots.txt" />

<!-- For less capable mobile browsers
<link rel="stylesheet" media="handheld" href="css/handheld.css?v=1">  -->

<!-- For all browsers -->
<link rel="stylesheet" media="screen" href="/css/style.css?v=1">

<link rel="stylesheet" media="print" href="/css/print.css?v=1">
<!-- For progressively larger displays -->
<link rel="stylesheet" media="only screen and (min-width: 480px)" href="/css/480.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 768px)" href="/css/768.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 992px)" href="/css/992.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 1382px)" href="/css/1382.css?v=1">
<!-- For Retina displays -->
<link rel="stylesheet" media="only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min-device-pixel-ratio: 2)" href="/css/2x.css?v=1">

<link rel="stylesheet" media="screen" href="/css/custom.css?v=1">

<!-- JavaScript at bottom except for Modernizr -->
<script src="/js/libs/modernizr-1.7.min.js"></script>

<!-- For iPhone 4 -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/h/apple-touch-icon.png">
<!-- For iPad 1-->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/m/apple-touch-icon.png">
<!-- For iPhone 3G, iPod Touch and Android -->
<link rel="apple-touch-icon-precomposed" href="/img/l/apple-touch-icon-precomposed.png">
<!-- For Nokia -->
<link rel="shortcut icon" href="/img/l/apple-touch-icon.png">
<!-- For everything else -->
<link rel="shortcut icon" href="/favicon.ico">

<!--iOS. Delete if not required -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-startup-image" href="/img/splash.png">

<!--Microsoft. Delete if not required -->
<meta http-equiv="cleartype" content="on">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<!-- http://t.co/y1jPVnT -->
<link rel="canonical" href="mef-and-chaining-dependencies.html">


</head>

<body class="clearfix">

<header role="banner" class="clearfix">
	<h1>MEF and Chaining Dependencies</h1>
</header>

<div class="content clearfix">

	<div id="post">
<p>A <a href="http://mef.codeplex.com/Thread/View">question</a> came up on the MEF discussion board recently (today?) about how to handle a complex graph of dependencies. Although it was "solved" - and I suspect it was a case of missing the required assembly, going by what info was at hand - it still prompted me to dig into how one can go beyond the basics.</p>

<h2>Scenario</h2>

<p>Imagine you have an application that calls off different services to execute tasks. Rather than hard-coding the services into the application, these can be defined as parts which are composed at runtime using MEF.</p>

<p>But the relationship between the application and the services is not straightforward, which gives a dependency graph similar to the below image:</p>

<center><img src="img/posts/DependencyGraph.png" height="500"  /></center>


<p>What should we do now?</p>

<p>As MEF uses the concept of a "contract" to resolve the [Import] and [Export]; statements sprinkled within an application, this ultimately comes down to two similar approaches.</p>

<h2>Using Contract Names</h2>

<p>If the Proxy and Service implementations are equivalent - so we can avoid using distinct interfaces for behaviour which is identical - then we can use the same interface and specify a different contract for each extensibiity point defined in the application.</p>

<pre><code>public class ConsumingApplication
{
    [ImportMany("Contoso.Application", typeof(IServiceProxy))]
    public IEnumerable&amp;lt;IServiceProxy&amp;gt; Services { get; set; }

    // implementation here
}
</code></pre>

<p>And our simple client can use the corresponding [Export] statement.</p>

<pre><code>[Export("Contoso.Application", typeof(IServiceProxy))]
public class StandaloneProxy : IServiceProxy
{
    // implementation here 
}
</code></pre>

<p>Our complex dependency has a bit more code, but it can be broken down into two main features:</p>

<p>The contract which it satisfies - <strong>Contoso.Application</strong> and <strong>IServiceProxy</strong></p>

<p>The contract which it requires - <strong>Contoso.External</strong> and <strong>IServiceProxy</strong></p>

<pre><code>[Export("Contoso.Application", typeof(IServiceProxy))]
public class ActualProxy : IServiceProxy
{
    [ImportMany("Contoso.External")]
    public IEnumerable&amp;lt;IServiceProxy&amp;gt; Services { get; set; }

    // implementation here
}
</code></pre>

<p>So while reusing the same interface, we can specify <em>how</em> the parts relate.</p>

<h2>Using Contract Types</h2>

<p>If the behaviour of the proxy and the actual service are different, then we can just use the types to represent the contract.</p>

<pre><code>public class ConsumingApplication
{
    [ImportMany(typeof(IServiceProxy))]
    public IEnumerable&amp;lt;IServiceProxy&amp;gt; Services { get; set; }

    // implementation here
}
</code></pre>

<p>The exported contract becomes:</p>

<pre><code>[Export(typeof(IServiceProxy))]
public class StandaloneProxy : IServiceProxy
{
    // implementation here
}
</code></pre>

<p>And our complex part still has two contracts:</p>

<p>The contract which it satisfies - the <strong>IServiceProxy</strong> contract.</p>

<p>The contract which it requires - the <strong>IService</strong> contract (implicit due to the awesomeness of ImportMany)</p>

<pre><code>[Export(typeof(IServiceProxy))]
public class ActualProxy : IServiceProxy
{
    [ImportMany]
    public IEnumerable&amp;lt;IService&amp;gt; Services { get; set; }

    // implementation here
}
</code></pre>

<p>No more magic strings, while still being able to declare</p>

<h2>And finally, InheritedExport</h2>

<p>To really simplify the contracts, you can use [InheritedExport] on the interface. This declares to MEF that all types which implement the interface should be used as exported parts, using the interface type as the contract.</p>

<p>So I annotate both interfaces:</p>

<pre><code>[InheritedExport]
public interface IServiceProxy
{
    // code here
}

&amp;#91;InheritedExport&amp;#92;
public interface IService
{
    // code here
}
</code></pre>

<p>and can eliminate all other [Export] attributes from the codebase:</p>

<pre><code>public class StandaloneProxy : IServiceProxy
{
    // implementation here
}

public class ActualProxy : IServiceProxy
{
    [ImportMany]
    public IEnumerable&amp;lt;IService&amp;gt; Services { get; set; }

    // implementation here
}
</code></pre>

<p>Thoughts?</p>

</div>


	<div id="disqus_thread"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://shiftkey.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>

<!--[if (lt IE 9) & (!IEMobile)]>
<script src="/js/libs/DOMAssistantCompressed-2.8.js"></script>
<script src="/js/libs/selectivizr-1.0.1.js"></script>
<script src="/js/libs/respond.min.js"></script>
<![endif]-->

<script>
var _gaq=[['_setAccount','UA-8441214-1'],['_trackPageview']]; 
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<noscript>Your browser does not support JavaScript!</noscript>

</body>
</html>