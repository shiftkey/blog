<!DOCTYPE html>

<!-- 
320 and Up boilerplate extension
Author: Andy Clarke
Version: 0.9b
URL: http://stuffandnonsense.co.uk/projects/320andup 
-->

<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" manifest="default.appcache?v=1" lang="en"><!--<![endif]-->

<head>
<meta charset="utf-8">

<title>WinRT Experiments</title>
<meta name="description" content="">
<meta name="author" content="brendan forster">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">

<!-- robots -->
<meta name="robots" content="/robots.txt" />

<!-- For less capable mobile browsers
<link rel="stylesheet" media="handheld" href="css/handheld.css?v=1">  -->

<!-- For all browsers -->
<link rel="stylesheet" media="screen" href="/css/style.css?v=1">

<link rel="stylesheet" media="print" href="/css/print.css?v=1">
<!-- For progressively larger displays -->
<link rel="stylesheet" media="only screen and (min-width: 480px)" href="/css/480.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 768px)" href="/css/768.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 992px)" href="/css/992.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 1382px)" href="/css/1382.css?v=1">
<!-- For Retina displays -->
<link rel="stylesheet" media="only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min-device-pixel-ratio: 2)" href="/css/2x.css?v=1">

<link rel="stylesheet" media="screen" href="/css/custom.css?v=1">

<!-- JavaScript at bottom except for Modernizr -->
<script src="/js/libs/modernizr-1.7.min.js"></script>

<!-- For iPhone 4 -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/h/apple-touch-icon.png">
<!-- For iPad 1-->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/m/apple-touch-icon.png">
<!-- For iPhone 3G, iPod Touch and Android -->
<link rel="apple-touch-icon-precomposed" href="/img/l/apple-touch-icon-precomposed.png">
<!-- For Nokia -->
<link rel="shortcut icon" href="/img/l/apple-touch-icon.png">
<!-- For everything else -->
<link rel="shortcut icon" href="/favicon.ico">

<!--iOS. Delete if not required -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-startup-image" href="/img/splash.png">

<!--Microsoft. Delete if not required -->
<meta http-equiv="cleartype" content="on">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<!-- http://t.co/y1jPVnT -->
<link rel="canonical" href="/build/whats-inside-a-winmd-file.html">
</head>


<link rel="stylesheet" media="screen" href="/css/build.css?v=1">

<body class="clearfix">

<header role="banner" class="clearfix">
	<h1>WinRT Experiments</h1>
</header>

<div class="content clearfix">
	<article>
		<img class='right ' src='/img/main/metro-preview.png' width='400' height='300' alt='' title=''>

		<header>
    <h2>Customise a Windows Metadata File</h2>
</header>


    <section>
        Following up from yesterday's adventures with winmdexp.exe and its API demands, I dove a little bit deeper into the process of turning C# source code into a WinMD binary, using a scenario near and dear to my heart.
    </section>

    <section>
        <header><h4>The Experiment - Post-Build Weaving</h4></header>

        A common scenario for XAML developers is ensuring all their classes implement INotifyPropertyChanged and the code to raise the change is in the setter for each property. Which leads to code like this:<br /><br />

        <pre>
public sealed class ShellViewModel : ViewModelBase
{
    private string someProperty;
    public string SomeProperty   
    { 
        get { return someProperty; }
        set 
        { 
            someProperty = value;
            OnPropertyChanged("SomeProperty");
        }
    }
}
        </pre>

        As a jaded developer, I want to do this:<br /><br />

        <pre>
public sealed class ShellViewModel : INotifyPropertyChanged
{
    public string SomeProperty  { get; set; }

    public event PropertyChangedEventHandler PropertyChanged;
}
        </pre>

        and have the framework generate the plumbing code. Because I'm getting too old for this shit.<br /><br />
    </section>

    <section>
        <header><h5>First Step: Add the build task</h5></header>

        I downloaded a build of NotifyPropertyWeaver and referenced the post-build task at the end of the .csproj file. This is exactly the same as how you'd do this when working against a WPF/SL/WP7 apps.<br /><br />

        <pre>
&lt;Project&gt;
    &lt;!-- existing project file elements --&gt;
    &lt;UsingTask TaskName="NotifyPropertyWeaverMsBuildTask.WeavingTask" 
                AssemblyFile="$(SolutionDir)lib\NotifyPropertyWeaverMsBuildTask.dll" /&gt;
    &lt;Target Name="AfterCompile"&gt;
        <strong>&lt;NotifyPropertyWeaverMsBuildTask.WeavingTask /&gt;</strong>
    &lt;/Target&gt;
&lt;/Project&gt;
        </pre>

        And that's it. By default, NotifyPropertyWeaver will inject code into all properties of types in this project, which implement INotifyPropertyChanged. There's a number of <a href="http://code.google.com/p/notifypropertyweaver/wiki/WeavingTaskOptions">options available</a>, if you want more control over the process.

    </section>

    <section>
        <header><h5>Step Two: Push the Red Button</h5></header>

        Now reload the project file and build the solution. Did it succeed? Did the earth move for you, too?

    </section>

    <section>
        <header><h5>Step Three: Everybody freak out</h5></header>

        Navigate to your <strong>bin/Debug</strong> folder to see the build output.<br /><br />

        <img class='left ' src='/img/posts/Win8/build-output.png' width='' height='' alt='' title=''>

        No assembly? A foreign .winmd file?<br /><br />

        Take a deep breath, Alice, for the adventure is just beginning.
    </section>
    
    <section>
        <header><h5>Step Four: To the rabbit hole!</h5></header>

        With that out of the way, open the <strong>Developer Command Prompty</strong> from the Search | Apps menu and enter <strong>ildasmn</strong>. This is a tool which has been around for aeons (in internet time) for disassembling .NET assemblies.<br /><br />

    </section>



    <section>
        <header><h5>Special Mention</h5></header>

        A big thanks to <a href="http://twitter.com/SimonCropp">Simon Cropp</a>, the guy who maintains <a href="http://code.google.com/p/notifypropertyweaver">NotifyPropertyWeaver</a>. He sent me a new build to test this within about an hour of demanding the feature!
    </section>

    <section>
        <header>
            <h5>What next?
        </header>

        If you've got any feedback on this (or perhaps I've gone astray on something), you can reach me on <a href="http://twitter.com/shiftkey">Twitter (@shiftkey)</a> or you can email me - 'me' @ this-domain. <br /><br />



    </section>
	</article>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>

<!--[if (lt IE 9) & (!IEMobile)]>
<script src="/js/libs/DOMAssistantCompressed-2.8.js"></script>
<script src="/js/libs/selectivizr-1.0.1.js"></script>
<script src="/js/libs/respond.min.js"></script>
<![endif]-->

<script>
var _gaq=[['_setAccount','UA-8441214-1'],['_trackPageview']]; 
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<noscript>Your browser does not support JavaScript!</noscript>

</body>
</html>