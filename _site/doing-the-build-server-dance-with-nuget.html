<!DOCTYPE html>

<!-- 
320 and Up boilerplate extension
Author: Andy Clarke
Version: 0.9b
URL: http://stuffandnonsense.co.uk/projects/320andup 
-->

<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!-- TODO: appcache definition -->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>
<meta charset="utf-8">

<title>Doing the build server dance with NuGet</title>
<meta name="description" content="">
<meta name="author" content="brendan forster">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">

<!-- robots -->
<meta name="robots" content="/robots.txt" />

<!-- For less capable mobile browsers
<link rel="stylesheet" media="handheld" href="css/handheld.css?v=1">  -->

<!-- For all browsers -->
<link rel="stylesheet" media="screen" href="/css/style.css?v=1">

<link rel="stylesheet" media="print" href="/css/print.css?v=1">
<!-- For progressively larger displays -->
<link rel="stylesheet" media="only screen and (min-width: 480px)" href="/css/480.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 768px)" href="/css/768.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 992px)" href="/css/992.css?v=1">
<link rel="stylesheet" media="only screen and (min-width: 1382px)" href="/css/1382.css?v=1">
<!-- For Retina displays -->
<link rel="stylesheet" media="only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min-device-pixel-ratio: 2)" href="/css/2x.css?v=1">

<link rel="stylesheet" media="screen" href="/css/custom.css?v=1">

<!-- JavaScript at bottom except for Modernizr -->
<script src="/js/libs/modernizr-1.7.min.js"></script>

<!-- For iPhone 4 -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/h/apple-touch-icon.png">
<!-- For iPad 1-->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/m/apple-touch-icon.png">
<!-- For iPhone 3G, iPod Touch and Android -->
<link rel="apple-touch-icon-precomposed" href="/img/l/apple-touch-icon-precomposed.png">
<!-- For Nokia -->
<link rel="shortcut icon" href="/img/l/apple-touch-icon.png">
<!-- For everything else -->
<link rel="shortcut icon" href="/favicon.ico">

<!--iOS. Delete if not required -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-startup-image" href="/img/splash.png">

<!--Microsoft. Delete if not required -->
<meta http-equiv="cleartype" content="on">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<!-- http://t.co/y1jPVnT -->
<link rel="canonical" href="doing-the-build-server-dance-with-nuget.html">
</head>


<body class="clearfix">

<header role="banner" class="clearfix">
	<h1>Doing the build server dance with NuGet</h1>
</header>

<div class="content clearfix">

	<div id="post">
<p>I started exploring NuGet package building yesterday evening, as a strategy for managing dependencies between projects I'm involved with.</p>

<p>And with NuGet in the enterprise being the <a href="http://www.hanselman.com/blog/NuGetForTheEnterpriseNuGetInAContinuousIntegrationAutomatedBuildSystem.aspx">upcoming hotness</a>, I thought I'd see how I could get companies I work with to start doing similar things with their internal projects. It was much easier than I'd expected, with a couple of hurdles.</p>

<h2>The Goal</h2>

<p>I have two projects, A and B. A has no upstream dependencies (that have NuGet packages, anyway), but B requires A.</p>

<p>So, after A builds and passes its tests, I want to:</p>

<ul>
<li>Create a new package for A, using it's build number.</li>
<li>Publish the package for A somewhere</li>
<li>Trigger a new build for B, using the newest version of A.</li>
<li>Verify B builds and passes tests.</li>
<li>Create a new package for B, using it's build number.</li>
<li>Publish the package for B somewhere.</li>
</ul>


<p>After a couple of hours work, I'm 95% of the way there.</p>

<h2>Defining the package specification</h2>

<p>As I wasn't really familiar with the process of creating the .nuspec file (sorry <a href="http://twitter.com/damianedwards">Damo</a>, your NDC talk was a long time ago :)) I decided to go and craft it by hand. I used this <a href="http://lostechies.com/joshuaflanagan/2011/06/23/tips-for-building-nuget-packages/">blog post</a> by <a href="http://twitter.com/jflanagan">Joshua Flanagan</a> (including a good reference <a href="https://github.com/DarthFubuMVC/bottles/blob/6d82e063fd889ac1909c98adc369a97b4c1e377e/packaging/nuget/bottles.nuspec">nuspec file</a>) to get started.</p>

<p>And that's about it. Put that into my build folder along with the NuGet.exe - I grabbed the latest one from the 1.4 OOB build on <a href="http://ci.nuget.org:8080/">NuGet CI server</a> due to an issue with how it parses the &lt;files&gt; element. This should be part of the next release.</p>

<h2>Building the package on the server</h2>

<p>So, I'm using TeamCity to build the project. Thus, I can use the build number directly against the NuGet package.</p>

<p>NOTE: Using the default value TeamCity provides for a project, which is just an incrementing integer, will fail with a "Version string portion was too short or too long" error. To fix that, go to General Settings and make it something more descriptive:</p>

<p><img src="img/posts/NuGet/BuildNumber.png" alt="General Settings" /></p>

<p>With that in place, the next step is to add in a post-build step:</p>

<p><a href="/img/posts/NuGet/PackageStep.png"><img src="/img/posts/NuGet/PackageStep-Small.png" alt="Post Build Step" /></a></p>


<p>The script I've used (duplicated for two different packages):</p>

<pre><code>del *.nupkg

.\NuGet.exe pack Package.nuspec -Version %system.build.number%
</code></pre>

<p>That script is courtesy of Scott Kirkland, who also has a decent guide to using NuGet on TC <a href="http://weblogs.asp.net/srkirkland/archive/2011/03/29/deploy-nuget-packages-during-ci-build-with-teamcity.aspx">here</a></p>

<h2>Publishing the package</h2>

<p>I didn't want to publish these packages to the NuGet gallery immediately, so what other options do I have? I could set up my own NuGet gallery. Or I could use <a href="http://www.myget.org/">MyGet</a> and skip all the hassle.</p>

<p>For those who aren't familiar with MyGet, its a service to create custom NuGet feeds. All I've done so far is create a private feed (which anyone can consume) and obtained an API key.</p>

<p><a href="img/posts/NuGet/myget.png"><img src="img/posts/NuGet/myget-small.png" alt="Post Build Step" /></a></p>


<p>While MyGet supports the ability to upload or create packages within the admin UI, I was feeling lazy and wanted to push packages from the build server.</p>

<p>This required an additional line in the script:</p>

<pre><code>del *.nupkg

.\NuGet.exe pack Package.nuspec -Version %system.build.number%

forfiles /m *.nupkg /c "cmd /c NuGet.exe push @FILE &lt;your-key&gt; -Source https://www.myget.org/F/mahapps/"
</code></pre>

<p>which will find all .nupkg files and invoke <em>push</em> against the specific repository - in this case, my private feed.</p>

<h2>Trigger a new build</h2>

<p>This isn't directly related to NuGet, but I wanted to force a new build when upstream packages change in TeamCity.</p>

<p>Under Build Triggering in the Project Configuration, add a trigger for "Finish Build" and select the upstream project.</p>

<p><a href="img/posts/NuGet/buildtriggering.png"><img src="img/posts/NuGet/buildtriggering-small.png" alt="Add Build Trigger" /></a></p>


<h2>Update the package for A and test</h2>

<p>Right, this is where things get rough.</p>

<p>I added a step before building the project, and executed this command:</p>

<pre><code>.\Nuget.exe update ..\MahApps.Twitter.sln -Source http://www.myget.org/f/mahapps
</code></pre>

<p>which will look through all the projects in my solution and update to the newest packages it can find. I've added in my MyGet feed URL to grab the latest packages from the specific feed.</p>

<p>And this works. Kinda.</p>

<p><a href="img/posts/NuGet/updatescripts.png"><img src="img/posts/NuGet/updatescripts-small.png" alt="Success?" /></a></p>


<p>It updates my projects, but doesn't store updated packages locally.
Which causes my build to break.</p>

<p><a href="img/posts/NuGet/compileerrors.png"><img src="img/posts/NuGet/compileerrors-small.png" alt="Oops" /></a></p>


<p>Scouring the forums produced <a href="http://nuget.codeplex.com/discussions/264082">this discussion</a> on this issue, which recommended this workaround:</p>

<pre><code>nuget install MyProj\packages.config -o packages
</code></pre>

<p><strong>NOTE</strong>: a minor grievance with the <em>install</em> command. Unlike the <em>update</em> command, this works against a project's repository. This seems subpar, when I can call <em>update</em> against a solution file. Can we get some consistency with this? Or have I missed something with how install behaves?</p>

<p>Fine, not all workarounds are pretty.</p>

<p>Let's modify my script to suit:</p>

<pre><code>.\Nuget.exe update ..\MahApps.Twitter.sln -Source http://www.myget.org/f/mahapps -Source https://go.microsoft.com/fwlink/?LinkID=206669 -o ..\packages

.\Nuget.exe install ..\src\Identica\packages.config -Source http://www.myget.org/f/mahapps -Source https://go.microsoft.com/fwlink/?LinkID=206669 -o ..\packages

.\Nuget.exe install ..\src\NET4\packages.config -Source http://www.myget.org/f/mahapps -Source https://go.microsoft.com/fwlink/?LinkID=206669 -o ..\packages

.\Nuget.exe install ..\src\Tests\packages.config -Source http://www.myget.org/f/mahapps -Source https://go.microsoft.com/fwlink/?LinkID=206669 -o ..\packages

.\Nuget.exe install ..\src\WP7\packages.config -Source http://www.myget.org/f/mahapps -Source https://go.microsoft.com/fwlink/?LinkID=206669 -o ..\packages
</code></pre>

<p>Icky. Whatever, I've got awesome to do.</p>

<p><em>https://go.microsoft.com/fwlink/?LinkID=206669</em> is the path to the official NuGet feed (the build server couldn't find some packages), and it is explicitly after my local feed (I may have some custom packages which I prefer). And I've added the "-o" parameter to point to the default packages location, just in case.</p>

<p>Aaaaand...</p>

<p><a href="img/posts/NuGet/installedpackages.png"><img src="img/posts/NuGet/installedpackages-small.png" alt="Success!" /></a></p>


<p>Booyah!</p>

<h2>TODO</h2>

<ul>
<li>submit patch for making update more "correct" ?</li>
<li>demonstrate how to add to VS tooling and how it changes dev story</li>
<li>some documentation on managing upstream dependencies</li>
</ul>


</div>


	<div id="disqus_thread"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://shiftkey.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
<!--  some stuff -->


<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>18 Jun 2011</span> &raquo; <a href="inotifypropertychanged-stop-the-madness.html">Soapbox: INotifyPropertyChanged - Stop the Madness</a></li>
    
      <li><span>08 Jun 2011</span> &raquo; <a href="on-the-windows-8-preview.html">On the Windows 8 Preview Video</a></li>
    
      <li><span>06 May 2011</span> &raquo; <a href="slsvcutil-stackoverflowexception-workaround.html">slsvcutil - Workaround StackOverflowException</a></li>
    
  </ul>
</div>

</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>

<!--[if (lt IE 9) & (!IEMobile)]>
<script src="/js/libs/DOMAssistantCompressed-2.8.js"></script>
<script src="/js/libs/selectivizr-1.0.1.js"></script>
<script src="/js/libs/respond.min.js"></script>
<![endif]-->

<script>
var _gaq=[['_setAccount','UA-8441214-1'],['_trackPageview']]; 
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<noscript>Your browser does not support JavaScript!</noscript>

</body>
</html>